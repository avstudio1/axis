<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axis Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #050505; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-gray-400 overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [mode, setMode] = useState('AUTO');
            const [notes, setNotes] = useState([]);
            const [logs, setLogs] = useState([{ t: new Date().toLocaleTimeString(), type: 'system', m: 'Axis TUI Online.' }]);
            const [selectedIndex, setSelectedIndex] = useState(0);
            const [showDetail, setShowDetail] = useState(false);
            const [aiInsight, setAiInsight] = useState(null);
            const scrollRef = useRef(null);

            const addLog = (type, message) => {
                setLogs(prev => [...prev.slice(-100), { t: new Date().toLocaleTimeString(), type, m: message }]);
            };

            // Initial Fetch
            const fetchNotes = async () => {
                try {
                    const res = await fetch('/api/notes');
                    if (!res.ok) throw new Error(res.statusText);
                    const data = await res.json();
                    setNotes(data || []);
                } catch (e) { addLog('error', 'Failed to fetch notes.'); }
            };

            // Mode Toggle
            const toggleMode = async (newMode) => {
                try {
                    await fetch(`/api/mode?set=${newMode}`);
                    setMode(newMode);
                } catch (e) { addLog('error', 'Failed to sync mode.'); }
            };

            // Delete Note
            const deleteNote = async (id) => {
                try {
                    const res = await fetch(`/api/notes/delete?id=${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        addLog('success', `Deleted: ${id}`);
                        fetchNotes();
                    } else {
                        const err = await res.text();
                        addLog('error', `Kill failed: ${err}`);
                    }
                } catch (e) { addLog('error', 'Network error on delete.'); }
            };

            // Gemini Synthesis
            const handleSynthesize = async () => {
                const note = notes[selectedIndex];
                if (!note) return;
                addLog('system', `âœ¨ AI Analysis: ${note.Title}`);
                setAiInsight("Synthesizing technical context... [SIMULATED]");
                setShowDetail(true);
            };

            useEffect(() => {
                fetchNotes();
                
                let eventSource;
                try {
                    // Robust URL construction
                    let streamUrl = '/api/stream';
                    if (window.location.host) {
                        const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
                        streamUrl = `${protocol}//${window.location.host}/api/stream`;
                    }

                    eventSource = new EventSource(streamUrl);
                    eventSource.onmessage = (e) => addLog('auto', e.data);
                    eventSource.onerror = () => {
                        // Silent fail for reconnects
                    };
                } catch (e) {
                    addLog('error', 'Telemetry stream initialization failed.');
                }

                return () => {
                    if (eventSource) eventSource.close();
                };
            }, []);

            useEffect(() => {
                if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
            }, [logs]);

            useEffect(() => {
                const handleKey = (e) => {
                    const key = e.key.toLowerCase();
                    if (key === 'a') toggleMode('AUTO');
                    if (key === 'm') toggleMode('MANUAL');
                    if (key === 'r') fetchNotes();

                    if (mode !== 'MANUAL') return;

                    if (showDetail) {
                        if (e.key === 'Escape') { setShowDetail(false); setAiInsight(null); }
                        return;
                    }

                    switch (e.key) {
                        case 'ArrowDown': setSelectedIndex(p => (p + 1) % notes.length); break;
                        case 'ArrowUp': setSelectedIndex(p => (p - 1 + notes.length) % notes.length); break;
                        case 'Enter': 
                        case ' ': setShowDetail(true); break;
                        case 's': handleSynthesize(); break;
                        case 'Delete': 
                        case 'Backspace': deleteNote(notes[selectedIndex].ID); break;
                    }
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [mode, notes, selectedIndex, showDetail]);

            return (
                <div className="flex flex-col h-screen p-4 select-none border-4 border-[#111]">
                    {/* Header */}
                    <div className="flex justify-between border-b border-gray-900 pb-2 mb-4 text-[10px] tracking-widest uppercase font-bold">
                        <div className="flex gap-6">
                            <span className={mode === 'AUTO' ? "text-emerald-500" : "text-gray-700"}>[A] AUTO</span>
                            <span className={mode === 'MANUAL' ? "text-yellow-500" : "text-gray-700"}>[M] MANUAL</span>
                            <span className="text-blue-500">[R] REFRESH</span>
                        </div>
                        <div className="flex gap-4">
                            <span className={mode === 'AUTO' ? "animate-pulse text-emerald-500" : "text-yellow-600"}>
                                ENGINE: {mode}
                            </span>
                        </div>
                    </div>

                    <div className="flex flex-1 gap-4 overflow-hidden">
                        {/* Telemetry */}
                        <div className="w-1/2 flex flex-col border border-gray-900 bg-black/20 p-2 rounded">
                            <div className="text-[9px] text-gray-600 mb-2 uppercase border-b border-gray-900 pb-1">Telemetry Buffer</div>
                            <div ref={scrollRef} className="flex-1 overflow-y-auto space-y-1 text-[11px] leading-tight opacity-80">
                                {logs.map((l, i) => (
                                    <div key={i} className="flex gap-2">
                                        <span className="text-gray-800">[{l.t}]</span>
                                        <span className={l.type === 'error' ? 'text-red-500' : l.type === 'success' ? 'text-emerald-500' : l.type === 'auto' ? 'text-emerald-700 italic' : 'text-blue-400'}>
                                            {l.m}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Registry */}
                        <div className="w-1/2 flex flex-col border border-gray-900 bg-black/20 p-2 rounded relative">
                            <div className="text-[9px] text-gray-600 mb-2 uppercase border-b border-gray-900 pb-1">Note Registry</div>
                            <div className="flex-1 overflow-y-auto">
                                {notes.map((n, i) => (
                                    <div key={n.ID} className={`p-2 border transition-all ${i === selectedIndex && mode === 'MANUAL' ? 'bg-emerald-950/20 border-emerald-500 text-emerald-400' : 'border-transparent text-gray-700'}`}>
                                        <div className="text-xs font-bold truncate">{n.Title}</div>
                                        <div className="text-[10px] opacity-60 truncate">{n.Snippet}</div>
                                    </div>
                                ))}
                            </div>

                            {showDetail && (
                                <div className="absolute inset-0 bg-[#050505] z-10 p-4 border border-blue-900/50 flex flex-col">
                                    <div className="flex justify-between text-[9px] text-blue-500 font-bold mb-2 uppercase border-b border-blue-900/20 pb-1">
                                        <span>Inspection: {notes[selectedIndex]?.Title}</span>
                                        <span>[ESC] CLOSE</span>
                                    </div>
                                    <div className="flex-1 text-[11px] text-blue-400 overflow-auto whitespace-pre-wrap leading-relaxed italic">
                                        {aiInsight || JSON.stringify(notes[selectedIndex], null, 2)}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="mt-4 pt-2 border-t border-gray-900 flex justify-between text-[9px] text-gray-600 uppercase tracking-tighter">
                        <div>ARROWS: Nav | ENTER: Detail | DEL: Kill | S: Gemini Insight</div>
                        <div className="text-emerald-900 font-bold italic">Axis v1.0.0 // Optimized for T12 Extension</div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>